<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>World of Babi</title>

<style>
html, body {
  margin: 0;
  overflow: hidden;
}
#fade {
  position: fixed;
  inset: 0;
  background: white;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.6s ease;
  z-index: 5;
}
</style>
</head>

<body>
<div id="fade"></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script>
const fade = document.getElementById("fade");

/* ===== LOAD SAVED POSITION ===== */
const saved = JSON.parse(localStorage.getItem("playerPos") || "{}");

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);

const camera = new THREE.PerspectiveCamera(75, innerWidth / innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

/* â˜€ï¸ LIGHT */
scene.add(new THREE.AmbientLight(0xffffff, 0.4));
const sun = new THREE.DirectionalLight(0xffffff, 1.2);
sun.position.set(50, 100, 50);
scene.add(sun);

/* ðŸŒ GROUND */
const ground = new THREE.Mesh(
  new THREE.PlaneGeometry(300, 300),
  new THREE.MeshStandardMaterial({ color: 0x4caf50 })
);
ground.rotation.x = -Math.PI / 2;
scene.add(ground);

/* ðŸ›£ ROAD */
const road = new THREE.Mesh(
  new THREE.PlaneGeometry(12, 300),
  new THREE.MeshStandardMaterial({ color: 0x6d4c41 })
);
road.rotation.x = -Math.PI / 2;
scene.add(road);

/* ðŸ§ PLAYER */
const player = new THREE.Group();
const body = new THREE.Mesh(
  new THREE.CapsuleGeometry(0.6, 1.2, 4, 8),
  new THREE.MeshStandardMaterial({ color: 0x333 })
);
body.position.y = 1.5;
player.add(body);
scene.add(player);

player.position.set(
  saved.x ?? 0,
  0,
  saved.z ?? 10
);

/* ðŸŽ¥ CAMERA */
let yaw = saved.yaw ?? 0;
let pitch = 0;
document.addEventListener("mousemove", e => {
  yaw -= e.movementX * 0.002;
  pitch -= e.movementY * 0.002;
  pitch = Math.max(-0.6, Math.min(0.6, pitch));
});

/* ðŸ  HOUSE + PORTAL */
const portals = [];

function house(x, z, color, link) {
  const g = new THREE.Group();

  const base = new THREE.Mesh(
    new THREE.BoxGeometry(6, 4, 6),
    new THREE.MeshStandardMaterial({ color })
  );
  base.position.y = 2;
  g.add(base);

  const roof = new THREE.Mesh(
    new THREE.ConeGeometry(5, 3, 4),
    new THREE.MeshStandardMaterial({ color: 0x8d6e63 })
  );
  roof.position.y = 5;
  roof.rotation.y = Math.PI / 4;
  g.add(roof);

  const door = new THREE.Mesh(
    new THREE.PlaneGeometry(1.5, 2.5),
    new THREE.MeshStandardMaterial({ color: 0xffffff })
  );
  door.position.set(0, 1.25, 3.01);
  door.userData.link = link;
  g.add(door);

  g.position.set(x, 0, z);
  scene.add(g);
  portals.push(door);
}

house(-15, -20, 0xffcc80, "home.html");
house(15, -40, 0x90caf9, "photos.html");
house(-15, -60, 0xa5d6a7, "about.html");
house(15, -80, 0xf48fb1, "contact.html");

/* âŒ¨ï¸ CONTROLS */
const keys = {};
addEventListener("keydown", e => keys[e.code] = true);
addEventListener("keyup", e => keys[e.code] = false);

const raycaster = new THREE.Raycaster();

function animate() {
  requestAnimationFrame(animate);

  const speed = 0.15;
  const dir = new THREE.Vector3(Math.sin(yaw), 0, Math.cos(yaw));

  if (keys.KeyW) player.position.addScaledVector(dir, -speed);
  if (keys.KeyS) player.position.addScaledVector(dir, speed);

  camera.position.set(
    player.position.x - Math.sin(yaw) * 6,
    player.position.y + 4,
    player.position.z - Math.cos(yaw) * 6
  );
  camera.lookAt(player.position.x, 2, player.position.z);

  /* ðŸšª PORTAL CHECK */
  raycaster.set(camera.position, dir.clone().negate());
  const hit = raycaster.intersectObjects(portals);
  if (hit.length && hit[0].distance < 3) {
    localStorage.setItem("playerPos", JSON.stringify({
      x: player.position.x,
      z: player.position.z,
      yaw
    }));
    fade.style.opacity = 1;
    setTimeout(() => location.href = hit[0].object.userData.link, 600);
  }

  renderer.render(scene, camera);
}
animate();
</script>
</body>
</html>
